name: promote-to-prod

on:
  workflow_dispatch:
    inputs:
      bundle-name:
        description: "The name of the release bundle"
        required: true
      bundle-version:
        description: "The release bundle version"
        required: true

permissions:
  id-token: write
  contents: read

env:
  JFROG_CLI_BUILD_NAME: ${{ vars.BUILD_NAME }}
  JFROG_CLI_BUILD_NUMBER: ${{ github.run_number }}
  JFROG_CLI_BUILD_PROJECT: ${{ vars.JF_PROJECT }}
  CUSTOM_SERVER_ID: "default"

jobs:  
  policy-check-and-promote-to-prod:
    runs-on: ubuntu-latest
    steps:
    
      - name: Install jfrog cli
        id:   setup-cli
        uses: jfrog/setup-jfrog-cli@v4
        env:
          JF_URL: https://${{ vars.ARTIFACTORY_URL }}
          JF_PROJECT: ${{ env.JFROG_CLI_BUILD_PROJECT }}
        with:
         oidc-provider-name: ${{ vars.OIDC_PROVIDER }}
         oidc-audience: ${{ vars.OIDC_PROVIDER }}
    
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup OPA
        uses: open-policy-agent/setup-opa@v2
        with:
         version: latest
         
      - name: Call GraphQL
        run: |
          ./scripts/graphql.sh https://${{ vars.ARTIFACTORY_URL }} ${{ steps.setup-cli.outputs.oidc-token }} ${{ env.JFROG_CLI_BUILD_PROJECT }}-release-bundles-v2 ${{ inputs.bundle-name }} ${{ inputs.bundle-version }} ./evidence-graph.json
          cat ./evidence-graph.json
      - name: Run policy
        id: run_policy
        run: |
          opa eval --input ./evidence-graph.json --data ./policy/policy.rego "data.policy.output" | jq '.result[0].expressions[0].value'  > policy.json
          echo "-----------------------------------"
          cat policy.json
          echo "-----------------------------------"
          result=$(jq .approved ./policy.json)
          echo "RESULT=$result"
          echo "RESULT=$result" >> $GITHUB_STEP_SUMMARY
          echo "RESULT=$result" >> $GITHUB_ENV
      - name: Promote to Production
        run: |
          if [ "${{ env.RESULT }}" == "true" ]; then
            jf evd create --key "${{ secrets.PRIVATE_KEY }}" --key-alias "${{ vars.EVIDENCE_KEY_ALIAS }}" \
              --release-bundle ${{ inputs.bundle-name }} --release-bundle-version ${{ inputs.bundle-version }} \
              --predicate ./policy.json --predicate-type https://jfrog.com/evidence/approval/v1 --project ${{ env.JFROG_CLI_BUILD_PROJECT }}
            jf release-bundle-promote ${{ inputs.bundle-name }} ${{ inputs.bundle-version }} PROD --signing-key ${{ vars.GPG_KEY }}  --sync=true --project=${{ env.JFROG_CLI_BUILD_PROJECT }}
            echo "ðŸš€ Succesfully promote to \`PROD\` environemnt" >> $GITHUB_STEP_SUMMARY
          else
            echo "Fail promotion policy check" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

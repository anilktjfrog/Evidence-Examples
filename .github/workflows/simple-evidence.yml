name: rbv2-evidence

on: [workflow_dispatch]

permissions:
  id-token: write
  contents: read
env:
  JFROG_CLI_BUILD_NAME: ${{ vars.BUILD_NAME }}
  JFROG_CLI_BUILD_NUMBER: ${{ github.run_number }}
  JFROG_CLI_BUILD_PROJECT: ${{ vars.JF_PROJECT }}
  CUSTOM_SERVER_ID: "default"

jobs:
  docker-build-with-rbv2-evidence:
    runs-on: self-hosted
    steps:
      - name: Install jfrog cli
        id: setup-cli
        uses: jfrog/setup-jfrog-cli@v4
        env:
          JF_URL: https://${{ vars.ARTIFACTORY_URL }}
          JF_PROJECT: ${{ env.JFROG_CLI_BUILD_PROJECT }}
        with:
          oidc-provider-name: ${{ vars.OIDC_PROVIDER }}
          oidc-audience: ${{ vars.OIDC_PROVIDER }}
          custom-server-id: ${{ env.CUSTOM_SERVER_ID }}

      - uses: actions/checkout@v4

      - name: Perform JF audit
        run: |
          # Configure JFrog CLI for evidence service
          jf config use ${{ env.CUSTOM_SERVER_ID }}

          echo "Perform Audit of source code"
          #jf audit --sca=true --licenses=true --vuln=true --format=table --extended-table=true --fail=false 

      - name: Log in to Artifactory Docker Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ vars.ARTIFACTORY_URL }}
          username: ${{ steps.setup-cli.outputs.oidc-user }}
          password: ${{ steps.setup-cli.outputs.oidc-token }}

      - name: Build and Push Docker image
        id: docker-build
        run: |
          # Configure JFrog CLI for evidence service
          jf config use ${{ env.CUSTOM_SERVER_ID }}
          
          # Build the Docker image
          docker build \
            --build-arg REPO_URL=${{ vars.ARTIFACTORY_URL }}/${{ vars.DEV_DOCKER_REPO_KEY }} \
            --tag ${{ vars.ARTIFACTORY_URL }}/${{ vars.DEV_DOCKER_REPO_KEY }}/${{ vars.IMAGE_NAME }}:${{ env.JFROG_CLI_BUILD_NUMBER }} \
            .

          # Push the Docker image
          docker push ${{ vars.ARTIFACTORY_URL }}/${{ vars.DEV_DOCKER_REPO_KEY }}/${{ vars.IMAGE_NAME }}:${{ env.JFROG_CLI_BUILD_NUMBER }}

          # Get the image digest for later use
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' ${{ vars.ARTIFACTORY_URL }}/${{ vars.DEV_DOCKER_REPO_KEY }}/${{ vars.IMAGE_NAME }}:${{ env.JFROG_CLI_BUILD_NUMBER }} | cut -d'@' -f2)
          echo "digest=${DIGEST}" >> $GITHUB_OUTPUT

      - name: add docker package to build
        run: |
          # Configure JFrog CLI for evidence service
          jf config use ${{ env.CUSTOM_SERVER_ID }}
          
          echo "${{ vars.ARTIFACTORY_URL }}/${{ vars.DEV_DOCKER_REPO_KEY }}/${{ vars.IMAGE_NAME }}:${{ env.JFROG_CLI_BUILD_NUMBER }}@${{ steps.docker-build.outputs.digest }}" > metadata.json
          jf rt build-docker-create ${{ vars.DEV_DOCKER_REPO_KEY }} --image-file metadata.json --build-name ${{ env.JFROG_CLI_BUILD_NAME }} --build-number ${{ env.JFROG_CLI_BUILD_NUMBER }} --project ${{ env.JFROG_CLI_BUILD_PROJECT }}

      - name: Set Signing Evidence on Docker
        run: |
          # Configure JFrog CLI for evidence service
          jf config use ${{ env.CUSTOM_SERVER_ID }}

          # Create signing evidence JSON file
          SIGNING_ACTOR="${{ github.actor }}"
          SIGNING_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "{
          \"actor\": \"${SIGNING_ACTOR}\",
          \"date\": \"${SIGNING_DATE}\"
          }" > sign.json
          # Attach evidence using JFrog CLI
          jf evd create \
          --package-name ${{ vars.IMAGE_NAME }} \
          --package-version "${{ env.JFROG_CLI_BUILD_NUMBER }}" \
          --package-repo-name ${{ vars.DEV_DOCKER_REPO_KEY }} \
          --key "${{ secrets.PRIVATE_KEY }}" \
          --key-alias "${{ vars.EVIDENCE_KEY_ALIAS }}" \
          --predicate ./sign.json \
          --predicate-type https://jfrog.com/evidence/signature/v1 \
          --url https://${{ vars.ARTIFACTORY_URL }} \
          --access-token ${{ steps.setup-cli.outputs.oidc-token }} --project ${{ env.JFROG_CLI_BUILD_PROJECT }}
          # Log the result
          echo "ðŸ”Ž Evidence attached: 'signature' ðŸ”"

      - name: docker scan
        run: |
           # Configure JFrog CLI for evidence service
           jf config use ${{ env.CUSTOM_SERVER_ID }}
           
           jf docker pull ${{ vars.ARTIFACTORY_URL }}/${{ vars.DEV_DOCKER_REPO_KEY }}/${{ vars.IMAGE_NAME }}:${{ env.JFROG_CLI_BUILD_NUMBER }}
           #jf docker scan ${{ vars.ARTIFACTORY_URL }}/${{ vars.DEV_DOCKER_REPO_KEY }}/${{ vars.IMAGE_NAME }}:${{ env.JFROG_CLI_BUILD_NUMBER }} --vuln  --fail=false

      - name: Publish build info
        if: ${{ true }}
        run: |
          # Configure JFrog CLI for evidence service
          jf config use ${{ env.CUSTOM_SERVER_ID }}
          
          jf rt build-collect-env
          jf rt build-add-git
          jf rt build-publish

      - name: Sign Build Evidence
        run: |
          # Configure JFrog CLI for evidence service
          jf config use ${{ env.CUSTOM_SERVER_ID }}

          # Define actor and date for the signing evidence
          ACTOR="${{ github.actor }}"
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          # Create the signing evidence JSON file
          echo "{
          \"actor\": \"${ACTOR}\",
          \"date\": \"${DATE}\"
          }" > sign.json
          # Sign the build evidence using JFrog CLI
          jf evd create \
            --build-name "${{ env.JFROG_CLI_BUILD_NAME }}" \
            --build-number "${{ env.JFROG_CLI_BUILD_NUMBER }}" \
            --predicate ./sign.json \
            --predicate-type https://jfrog.com/evidence/build-signature/v1 \
            --key "${{ secrets.PRIVATE_KEY }}" \
            --key-alias "${{ vars.EVIDENCE_KEY_ALIAS }}" \
            --url https://${{ vars.ARTIFACTORY_URL }} \
            --access-token ${{ steps.setup-cli.outputs.oidc-token }} --project ${{ env.JFROG_CLI_BUILD_PROJECT }}
            
          # Add a summary entry to GitHub Actions
          echo "ðŸ”Ž Evidence attached: 'build-signature' ðŸ”" >> $GITHUB_STEP_SUMMARY

      - name: "Optional: Add Builds to Indexing Configuration"
        run: |
          # Configure JFrog CLI for evidence service
          jf config use ${{ env.CUSTOM_SERVER_ID }}
          
          jf xr curl "/api/v1/binMgr/builds" -H 'Content-Type: application/json' -d '{"names": ["${{env.JFROG_CLI_BUILD_NAME}}"] }'

      # Set properties to artifacts of build    
      - name: "Optional: Set prop for Artifact"  # These properties were captured Artifacts >> repo path 'spring-petclinic.---.jar' >> Properties
        run: |
          # Configure JFrog CLI for evidence service
          jf config use ${{ env.CUSTOM_SERVER_ID }}
          
          ts="cmd.$(date '+%Y-%m-%d-%H-%M')" 
          jf rt sp "job=github-action;env=demo;org=ps;team=arch;pack_cat=webapp;build=maven;product=artifactory;features=package,buildinfo;ts=ts-${{ env.JFROG_CLI_BUILD_NUMBER }}" --build="${{env.JFROG_CLI_BUILD_NAME}}/${{env.JFROG_CLI_BUILD_NUMBER}}" --project ${{ env.JFROG_CLI_BUILD_PROJECT }}

      - name: "Optional: Query build info"
        env: 
          BUILD_INFO_JSON: "BuildInfo-${{env.JFROG_CLI_BUILD_NUMBER}}.json"
        run: |
           # Configure JFrog CLI for evidence service
           jf config use ${{ env.CUSTOM_SERVER_ID }}
          
           jf rt curl "/api/build/${{env.JFROG_CLI_BUILD_NAME}}/${{env.JFROG_CLI_BUILD_NUMBER}}?project=${{env.JFROG_CLI_BUILD_PROJECT}}" -o $BUILD_INFO_JSON
           cat $BUILD_INFO_JSON

      - name: "Sleep for few seconds"
        env: 
          SLEEP_TIME: 30
        run: |
           echo "Sleeping for ${{env.SLEEP_TIME}} seconds..."
           sleep ${{env.SLEEP_TIME}}  # Sleeping for 20 seconds before executing the build publish seems to have resolved the build-scan issue. This delay might be helping with synchronization or resource availability, ensuring a smooth build process.
           echo "Awake now!"

      - name: "Optional: Query - Build Scan status"
        run: |
          # Configure JFrog CLI for evidence service
          jf config use ${{ env.CUSTOM_SERVER_ID }}
          
          jf xr curl "/api/v1/build/status" -H 'Content-Type: application/json' -d '{"name": "${{env.JFROG_CLI_BUILD_NAME}}", "number": "${{env.JFROG_CLI_BUILD_NUMBER}}", "project": "${{env.JFROG_CLI_BUILD_PROJECT}}" }'

      
      - name: Run build scan
        run: |
          # Configure JFrog CLI for evidence service
          jf config use ${{ env.CUSTOM_SERVER_ID }}
          
          jf build-scan ${{ env.JFROG_CLI_BUILD_NAME }}  ${{ env.JFROG_CLI_BUILD_NUMBER }} --project ${{ env.JFROG_CLI_BUILD_PROJECT }} --fail=false --format=table --extended-table=true --rescan=false --vuln=true
        
      - name: Create Release Bundle
        run: |
          # Configure JFrog CLI for evidence service
          jf config use ${{ env.CUSTOM_SERVER_ID }}
          
          # Create the bundle specification JSON
          echo "{
            \"files\": [
            {
           \"build\": \"${{ env.JFROG_CLI_BUILD_NAME }}/${{ env.JFROG_CLI_BUILD_NUMBER }}\",
            \"project\": \"${{ env.JFROG_CLI_BUILD_PROJECT }}\"
            }
          ]
          }" > bundle-spec.json

          # Created in the Signing key section in Artifactory - Admin > Security > Keys Management
          # Create the release bundle
          jf release-bundle-create \
          "${{ env.JFROG_CLI_BUILD_NAME }}" \
          "${{ env.JFROG_CLI_BUILD_NUMBER }}" \
          --signing-key ${{ vars.GPG_KEY }} \
          --spec bundle-spec.json \
          --sync=true --project ${{ env.JFROG_CLI_BUILD_PROJECT }}
          
          # Generate links to the release bundle
          ARTIFACTORY_UI="https://${{ vars.ARTIFACTORY_URL }}/ui/artifactory/lifecycle"
          NAME_LINK="${ARTIFACTORY_UI}/?bundleName=${{ env.JFROG_CLI_BUILD_NAME }}&bundleToFlash=${{ env.JFROG_CLI_BUILD_NAME }}&repositoryKey=${{ vars.RBV2REPOKEY }}&activeKanbanTab=promotion"
          VER_LINK="${ARTIFACTORY_UI}/?bundleName=${{ env.JFROG_CLI_BUILD_NAME }}&bundleToFlash=${{ env.JFROG_CLI_BUILD_NAME }}&releaseBundleVersion=${{ env.JFROG_CLI_BUILD_NUMBER }}&repositoryKey=${{ vars.RBV2REPOKEY }}&activeVersionTab=Version%20Timeline&activeKanbanTab=promotion"
          # Log the creation of the release bundle
          echo "ðŸ“¦ Release bundle [${{ env.JFROG_CLI_BUILD_NAME }}](${NAME_LINK}):[${{ env.JFROG_CLI_BUILD_NUMBER }}](${VER_LINK}) created" >> $GITHUB_STEP_SUMMARY

      - name: Promote to DEV
        run: |
          # Configure JFrog CLI for evidence service
          jf config use ${{ env.CUSTOM_SERVER_ID }} 
          
          jf release-bundle-promote ${{ env.JFROG_CLI_BUILD_NAME }} ${{ env.JFROG_CLI_BUILD_NUMBER }} DEV --signing-key ${{ vars.GPG_KEY }} --sync=true --project ${{ env.JFROG_CLI_BUILD_PROJECT }}
          echo "ðŸš€ Succesfully promote to \`DEV\` environemnt" >> $GITHUB_STEP_SUMMARY
      - name: Promote to QA
        run: |
          # Configure JFrog CLI for evidence service
          jf config use ${{ env.CUSTOM_SERVER_ID }}
          
          jf release-bundle-promote ${{ env.JFROG_CLI_BUILD_NAME }} ${{ env.JFROG_CLI_BUILD_NUMBER }} QA --signing-key ${{ vars.GPG_KEY }} --sync=true --project ${{ env.JFROG_CLI_BUILD_PROJECT }}
          echo "ðŸš€ Succesfully promote to \`QA\` environemnt" >> $GITHUB_STEP_SUMMARY
      - name: Promote to PROD
        run: |
          # Configure JFrog CLI for evidence service
          jf config use ${{ env.CUSTOM_SERVER_ID }}
          
          jf release-bundle-promote ${{ env.JFROG_CLI_BUILD_NAME }} ${{ env.JFROG_CLI_BUILD_NUMBER }} PROD --signing-key ${{ vars.GPG_KEY }} --sync=true --project ${{ env.JFROG_CLI_BUILD_PROJECT }}
          echo "ðŸš€ Succesfully promote to \`PROD\` environemnt" >> $GITHUB_STEP_SUMMARY
      - name: Attach Test Evidence to Release Bundle
        run: |
          # Configure JFrog CLI for evidence service
          jf config use ${{ env.CUSTOM_SERVER_ID }}

          ACTOR="${{ github.actor }}"         # Create the test evidence JSON
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          TEST_NAME="CI test"
          TEST_RESULT="success"
          echo "{
            \"actor\": \"${ACTOR}\",
            \"date\": \"${DATE}\",
            \"test\": \"${TEST_NAME}\",
            \"result\": \"${TEST_RESULT}\"
          }" > test_evidence.json
          # Generate link to the release bundle
          ARTIFACTORY_UI="https://${{ vars.ARTIFACTORY_URL }}/ui/artifactory/lifecycle"
          JF_LINK="${ARTIFACTORY_UI}/?bundleName=${{ env.JFROG_CLI_BUILD_NAME }}&bundleToFlash=${{ env.JFROG_CLI_BUILD_NAME }}&releaseBundleVersion=${{ env.JFROG_CLI_BUILD_NUMBER }}&repositoryKey=${{ vars.RBV2REPOKEY }}&activeVersionTab=Version%20Timeline&activeKanbanTab=promotion"
          # Log the test result in GitHub summary
          echo "Test on Release Bundle [${{ env.JFROG_CLI_BUILD_NAME }}:${{ env.JFROG_CLI_BUILD_NUMBER }}](${JF_LINK}) success" >> $GITHUB_STEP_SUMMARY
          # Attach evidence to the release bundle
          jf evd create \
          --release-bundle "${{ env.JFROG_CLI_BUILD_NAME }}" \
          --release-bundle-version "${{ env.JFROG_CLI_BUILD_NUMBER }}" \
          --predicate ./test_evidence.json \
          --predicate-type https://jfrog.com/evidence/testing-results/v1 \
          --key "${{ secrets.PRIVATE_KEY }}" \
          --key-alias "${{ vars.EVIDENCE_KEY_ALIAS }}" \
          --url https://${{ vars.ARTIFACTORY_URL }} \
          --access-token ${{ steps.setup-cli.outputs.oidc-token }} --project ${{ env.JFROG_CLI_BUILD_PROJECT }}
          
          # Log the evidence attachment
          echo "ðŸ”Ž Evidence attached: integration-test ðŸ§ª" >> $GITHUB_STEP_SUMMARY
